%================
% handy variables
\def\trt@empty{}%

%=================================
% to ease expansion control
\let\ex@f\expandafter
\def\trt@expShort@On{%
  \let\trt@oldless=\>%
  \let\>=\expandafter%
  \edef\@trt@old@quotecatcode{\the\catcode`\'}%
  \catcode`\'=\active%
  \let\trt@oldquote='% 
  \let'=\noexpand%
}
\def\trt@expShort@Off{%
  \let\>=\trt@oldless%
%   \let'=\trt@oldquote%
  \catcode`\'=\@trt@old@quotecatcode
}

%=================================
% debug helpers
\def \trt@arg@debug#1{%
  \begingroup%
  \toks@={#1}%
  \showthe\toks@%
  \endgroup%
}
%================================
% extra tests
\def \trt@if@empty#1{\if\relax\detokenize{#1}\relax}

%================================
% token list managment
\def \trt@toks@prepend#1->T#2{
  \begingroup
  \def \defhelper##1{
    \endgroup
    #2={#1##1}
  }
  \ex@f\defhelper\ex@f{\the#2}
}

%==========================
%% macro managment

\def \trt@macro@getdef#1->T#2{
  \begingroup%
  \def \parsemean##1->##2\@nil{%
    \endgroup% 
    #2={##2}
  }%
  \ex@f\parsemean\meaning#1\@nil
}

%=================================
%% to smuggle stuff outside a scope.

\def \trt@toks@smuggle#1\as#2\drop#3\endgroup{%
  #3\ex@f\endgroup\ex@f#2\ex@f{\the#1}%
} 
\def \trt@macro@smuggle#1\as#2\drop#3\endgroup{%
%   \trt@arg@debug{#1 \as #2 \drop #3}
  \toks@={#3}
  \ex@f\the\ex@f\toks@\ex@f\endgroup\ex@f\def\ex@f#2\ex@f{#1}%
}
\def \trt@csmacro@smuggle#1\as#2\drop#3\endgroup{%
  \bgroup%
  \def\wrap@smugglin##1{%
    \egroup%
    \ex@f\trt@macro@smuggle\ex@f{\csname #1\endcsname}\as{##1}\drop%
    \endgroup%
  }%
  #3\ex@f\wrap@smugglin\ex@f{\csname #2\endcsname}%
}


%==============================
% strips spaces from strings

% removes all spaces
% #1 -- string
% #2 -- token to store
\def \trt@str@rmSpc#1->T#2{%
  \begingroup%
    \toks@={}%
    \def\proc##1{%
      \ifx ##1\nil\let\next=\relax%
      \else \ex@f\toks@\ex@f{\the\toks@##1}\let\next=\proc%
      \fi%
      \next%
    }%
    \proc#1\nil%
    \trt@toks@smuggle{\toks@}\as{#2}\drop%
  \endgroup%
}

% removes only surrounding spaces
% #1 -- string
% #2 -- token to store
\def \trt@str@rmSpcSur#1->T#2{%
  \ifblank{#1}{}%from etoolbox
  {%
    \begingroup%
    \def\procbeg##1{##1}%
    \toks@=\ex@f{\procbeg#1}%
    % #1 -- separator, \@nil, for example
    % can't be passed literally, cs's gobble space
    \def\procend@def##1{%
      \def\procend####1 ##1####2\@end{%
        \trt@if@empty{####2}% no spaces at all
        \else \toks@={####1}%
        \fi%
      }%
      \ex@f\procend\the\toks@##1 ##1\@end%
    }%
    \procend@def{\@nil}%
    \trt@toks@smuggle{\toks@}\as{#2}\drop%
    \endgroup%
  }%
}


%=========================
% remove string prefix

% #1 -- string
% #2 -- prefix
% #3 -- toks to spoil
\def \trt@prefix@rm#1#2->T#3{%
  \begingroup%
  \def\procbeg#2##1\@nil{\endgroup #3={##1}}%
  \procbeg#1\@nil%
}

%==========================
% list-like arguments
%==========================
\def \trt@list@def#1#2{
  \def#1{}
  \forcsvlist{\listadd#1}{#2}
}

\def \trt@csmacro@makemultiple#1<*>#2\@nil{%
  \trt@if@empty{#1}%
% TODO: patching-like behaviour
% difficulties with \meaning and \scantokens
%     \begingroup% <-does not spoil external token lists:)
%     \ex@f\trt@macro@getdef\ex@f{\csname #1#2\endcsname}->T{\toks@}%
%     \toks@={}
%     \def\defhelper##1{
%       \trt@arg@debug{arg##1}
%       \endgroup
%       \csdef{#1#2}####1{
%         ##1
%         \docsvlist{####1}
%       }
%       \csshow{#1#2}
%     }
%     \ex@f\defhelper\ex@f{\the\toks@}
    \csletcs{#2@single}{#2}%
    \csedef{#2}##1{%
      \noexpand\forcsvlist\expandonce{\csname #2@single\endcsname}{##1}%
    }%
  \else%
    \csedef{#1s#2}##1{%
      \noexpand\forcsvlist\expandonce{\csname #1#2\endcsname}{##1}%
    }%
  \fi%
}

% vim:ft=plaintex
